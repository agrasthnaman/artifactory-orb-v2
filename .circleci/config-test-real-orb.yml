version: 2.1

# This config tests the REAL orb (published version)
# NOT the inline orb!

orbs:
  # Replace with your published dev version after: circleci orb publish orb.yml agrasth/artifactory-orb-v2@dev:test1
  artifactory: agrasth/artifactory-orb-v2@dev:test1

workflows:
  test-real-orb:
    jobs:
      # Test 1: Basic commands
      - test-orb-commands:
          context: jfrog-context
      
      # Test 2: Use orb's built-in upload job
      - artifactory/upload:
          name: test-orb-upload-job
          source: "*.txt"
          target: "${ARTIFACTORY_REPO:-libs-release-local}/orb-test/${CIRCLE_BUILD_NUM}/"
          build-name: "orb-upload-test"
          build-number: "${CIRCLE_BUILD_NUM}"
          context: jfrog-context
          build-steps:
            - run:
                name: Create test artifacts
                command: |
                  echo "Testing real orb - Build ${CIRCLE_BUILD_NUM}" > test-${CIRCLE_BUILD_NUM}.txt
                  echo "Created at: $(date)" >> test-${CIRCLE_BUILD_NUM}.txt

jobs:
  test-orb-commands:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      
      # Test: artifactory/install command
      - artifactory/install
      
      - run:
          name: Verify JFrog CLI Installation
          command: |
            echo "Testing orb's install command..."
            jf --version
            echo "âœ… Install command works!"
      
      # Test: artifactory/configure command  
      - artifactory/configure:
          server-id: "orb-test-server"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
      
      - run:
          name: Verify Configuration
          command: |
            echo "Testing orb's configure command..."
            jf config show orb-test-server
            echo "âœ… Configure command works!"
      
      # Create test artifact
      - run:
          name: Create Test Artifact
          command: |
            echo "Real orb test - Build ${CIRCLE_BUILD_NUM}" > orb-test.txt
            ls -la orb-test.txt
      
      # Test: artifactory/upload command
      - artifactory/upload:
          source: "orb-test.txt"
          target: "${ARTIFACTORY_REPO:-libs-release-local}/orb-cmd-test/${CIRCLE_BUILD_NUM}/"
          server-id: "orb-test-server"
          build-name: "orb-command-test"
          build-number: "${CIRCLE_BUILD_NUM}"
      
      - run:
          name: Verify Upload
          command: echo "âœ… Upload command works!"
      
      # Test: artifactory/build-integration command
      - artifactory/build-integration:
          build-name: "orb-command-test"
          build-number: "${CIRCLE_BUILD_NUM}"
          server-id: "orb-test-server"
          include-git: true
          include-env: true
      
      - run:
          name: Verify Build Integration
          command: echo "âœ… Build integration command works!"
      
      # Test: artifactory/download command
      - artifactory/download:
          source: "${ARTIFACTORY_REPO:-libs-release-local}/orb-cmd-test/${CIRCLE_BUILD_NUM}/*"
          target: "downloaded/"
          server-id: "orb-test-server"
      
      - run:
          name: Verify Download
          command: |
            echo "Downloaded files:"
            ls -laR downloaded/
            echo "âœ… Download command works!"
      
      - run:
          name: Summary
          command: |
            echo "================================"
            echo "âœ… Real Orb Test Results"
            echo "================================"
            echo "âœ… install command - PASSED"
            echo "âœ… configure command - PASSED"
            echo "âœ… upload command - PASSED"
            echo "âœ… build-integration command - PASSED"
            echo "âœ… download command - PASSED"
            echo "âœ… upload job - PASSED (separate job)"
            echo "================================"
            echo "ðŸŽ‰ All orb components working!"
            echo "================================"

