version: 2.1

# Local inline orb for testing WITHOUT publishing
# This embeds the orb directly in your config for testing

setup: true

orbs:
  artifactory:
    commands:
      install:
        description: Install JFrog CLI
        parameters:
          version:
            type: string
            default: "2"
            description: JFrog CLI major version (use "2" for latest v2)
        steps:
          - run:
              name: Install JFrog CLI
              command: |
                #!/bin/bash
                set -e
                
                # Check if already installed
                if command -v jf &> /dev/null; then
                    echo "JFrog CLI already installed: $(jf --version)"
                    exit 0
                fi
                
                VERSION="<<parameters.version>>"
                echo "Installing JFrog CLI v${VERSION} (latest)..."
                
                # Use official JFrog CLI installer (always gets latest)
                curl -fL https://install-cli.jfrog.io | sh -s "${VERSION}"
                
                # Move to PATH
                sudo mv jf /usr/local/bin/jf 2>/dev/null || true
                
                # Verify installation
                jf --version
                echo "JFrog CLI installed successfully!"

      configure:
        description: Configure JFrog CLI
        parameters:
          server-id:
            type: string
            default: "circleci-rt"
          url:
            type: string
          user:
            type: string
          apikey:
            type: string
        steps:
          - run:
              name: Configure JFrog CLI
              command: |
                #!/bin/bash
                set -e
                
                echo "Configuring JFrog CLI..."
                jf config add "<<parameters.server-id>>" \
                  --artifactory-url="<<parameters.url>>" \
                  --user="<<parameters.user>>" \
                  --password="<<parameters.apikey>>" \
                  --interactive=false
                
                echo "JFrog CLI configured successfully!"
                jf config show "<<parameters.server-id>>"

workflows:
  test-local-orb:
    jobs:
      - test-install-and-configure

jobs:
  test-install-and-configure:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      
      - artifactory/install:
          version: "2"
      
      - run:
          name: Verify Installation
          command: |
            echo "Testing JFrog CLI installation..."
            jf --version
      
      - artifactory/configure:
          server-id: "test-server"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
      
      - run:
          name: Verify Configuration
          command: |
            echo "Testing JFrog CLI configuration..."
            jf config show test-server
            echo "Configuration successful!"
      
      - run:
          name: Create Test File
          command: |
            echo "Test from CircleCI build ${CIRCLE_BUILD_NUM}" > test.txt
            ls -la test.txt
      
      - run:
          name: Test Upload (if configured)
          command: |
            # This will only work if you have ARTIFACTORY_* vars set
            if [ -n "$ARTIFACTORY_URL" ]; then
              jf rt upload "test.txt" "test-repo/circleci/" --server-id=test-server || echo "Upload failed (expected if no valid credentials)"
            else
              echo "Skipping upload - no ARTIFACTORY_URL set"
            fi

