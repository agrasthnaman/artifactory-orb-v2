version: 2.1

# Local inline orb for testing WITHOUT publishing
# This embeds the orb directly in your config for testing

setup: true

orbs:
  artifactory:
    commands:
      install:
        description: Install JFrog CLI
        parameters:
          version:
            type: string
            default: "2"
            description: JFrog CLI major version (use "2" for latest v2)
        steps:
          - run:
              name: Install JFrog CLI
              command: |
                #!/bin/bash
                set -e
                
                # Check if already installed
                if command -v jf &> /dev/null; then
                    echo "JFrog CLI already installed: $(jf --version)"
                    exit 0
                fi
                
                echo "Installing JFrog CLI (latest)..."
                
                # Use official installer without version parameter for latest
                curl -fL https://install-cli.jfrog.io | sh
                
                # Installer places jf in current directory, move to PATH
                if [ -f "./jf" ]; then
                    sudo mv ./jf /usr/local/bin/jf || mv ./jf ~/bin/jf || true
                    chmod +x /usr/local/bin/jf 2>/dev/null || chmod +x ~/bin/jf
                fi
                
                # Verify installation
                jf --version
                echo "JFrog CLI installed successfully!"

      configure:
        description: Configure JFrog CLI
        parameters:
          server-id:
            type: string
            default: "circleci-rt"
          url:
            type: string
          user:
            type: string
          apikey:
            type: string
        steps:
          - run:
              name: Configure JFrog CLI
              command: |
                #!/bin/bash
                set -e
                
                echo "Configuring JFrog CLI..."
                jf config add "<<parameters.server-id>>" \
                  --artifactory-url="<<parameters.url>>" \
                  --user="<<parameters.user>>" \
                  --password="<<parameters.apikey>>" \
                  --interactive=false
                
                echo "JFrog CLI configured successfully!"
                jf config show "<<parameters.server-id>>"

workflows:
  test-local-orb:
    jobs:
      # Test 1: Basic installation (no credentials needed)
      - test-install-and-configure
      
      # Test 2: Full test with real Artifactory (uses context)
      - test-full-workflow:
          context: jfrog-context  # Use your CircleCI context name here
          requires:
            - test-install-and-configure

jobs:
  test-install-and-configure:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      
      - artifactory/install:
          version: "2"
      
      - run:
          name: Verify Installation
          command: |
            echo "Testing JFrog CLI installation..."
            jf --version
      
      - artifactory/configure:
          server-id: "test-server"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
      
      - run:
          name: Verify Configuration
          command: |
            echo "Testing JFrog CLI configuration..."
            jf config show test-server
            echo "Configuration successful!"
      
      - run:
          name: Create Test File
          command: |
            echo "Test from CircleCI build ${CIRCLE_BUILD_NUM}" > test.txt
            ls -la test.txt
      
      - run:
          name: Test Upload (if configured)
          command: |
            # This will only work if you have ARTIFACTORY_* vars set
            if [ -n "$ARTIFACTORY_URL" ]; then
              jf rt upload "test.txt" "test-repo/circleci/" --server-id=test-server || echo "Upload failed (expected if no valid credentials)"
            else
              echo "Skipping upload - no ARTIFACTORY_URL set"
            fi

  test-full-workflow:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      
      - artifactory/install
      
      - artifactory/configure:
          server-id: "my-artifactory"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
      
      - run:
          name: Verify Configuration
          command: |
            echo "Verifying JFrog CLI configuration..."
            jf config show my-artifactory
      
      - run:
          name: Create Test Artifacts
          command: |
            echo "Build: ${CIRCLE_BUILD_NUM}" > artifact-${CIRCLE_BUILD_NUM}.txt
            echo "Project: ${CIRCLE_PROJECT_REPONAME}" >> artifact-${CIRCLE_BUILD_NUM}.txt
            echo "Branch: ${CIRCLE_BRANCH}" >> artifact-${CIRCLE_BUILD_NUM}.txt
            echo "Timestamp: $(date)" >> artifact-${CIRCLE_BUILD_NUM}.txt
            
            mkdir -p build/
            echo "Sample JAR content" > build/sample-app.jar
            echo "Sample config" > build/config.properties
            
            ls -la
            ls -la build/
      
      - run:
          name: Upload Artifacts to Artifactory
          command: |
            echo "Uploading artifacts to Artifactory..."
            
            # Upload single file
            jf rt upload "artifact-${CIRCLE_BUILD_NUM}.txt" \
              "generic-local/circleci-test/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}/" \
              --server-id=my-artifactory \
              --build-name="${CIRCLE_PROJECT_REPONAME}" \
              --build-number="${CIRCLE_BUILD_NUM}"
            
            # Upload directory
            jf rt upload "build/*" \
              "generic-local/circleci-test/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}/build/" \
              --server-id=my-artifactory \
              --build-name="${CIRCLE_PROJECT_REPONAME}" \
              --build-number="${CIRCLE_BUILD_NUM}"
            
            echo "Upload completed successfully!"
      
      - run:
          name: Collect Build Information
          command: |
            echo "Collecting build information..."
            
            # Collect environment variables
            jf rt build-collect-env "${CIRCLE_PROJECT_REPONAME}" "${CIRCLE_BUILD_NUM}" \
              --server-id=my-artifactory
            
            # Collect Git information
            jf rt build-add-git "${CIRCLE_PROJECT_REPONAME}" "${CIRCLE_BUILD_NUM}" \
              --server-id=my-artifactory
            
            echo "Build info collected!"
      
      - run:
          name: Publish Build Information
          command: |
            echo "Publishing build information to Artifactory..."
            
            jf rt build-publish "${CIRCLE_PROJECT_REPONAME}" "${CIRCLE_BUILD_NUM}" \
              --server-id=my-artifactory
            
            echo "Build info published!"
            echo "View in Artifactory: ${ARTIFACTORY_URL%/artifactory}/ui/builds/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}"
      
      - run:
          name: Download Artifacts (Test Download)
          command: |
            echo "Testing artifact download..."
            
            mkdir -p downloaded/
            jf rt download \
              "generic-local/circleci-test/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}/*" \
              "downloaded/" \
              --server-id=my-artifactory
            
            echo "Downloaded files:"
            ls -laR downloaded/
            
            echo "Download test successful!"

